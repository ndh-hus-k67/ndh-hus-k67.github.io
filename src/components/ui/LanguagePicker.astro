---
import { languages } from "@utils//ui";
import Icon from "./icons/Icon.astro";
---

<!-- Desktop: hs-dropdown (hover/click powered by Preline) -->
<div class="hs-dropdown relative hidden md:inline-flex">
  <button
    id="hs-dropdown-default"
    type="button"
    aria-label="Change language"
    title="Change language"
    class="hs-dropdown-toggle inline-flex items-center gap-x-2 rounded-lg px-1.5 py-1.5 text-sm font-medium text-neutral-600 outline-hidden ring-zinc-500 transition duration-300 hover:bg-neutral-200 hover:text-orange-400 dark:border-neutral-700 dark:text-neutral-400 dark:ring-zinc-200 dark:hover:bg-neutral-700 dark:hover:text-orange-300 dark:focus:outline-hidden"
  >
    <Icon name="earth" />
    <svg
      class="size-4 hs-dropdown-open:rotate-180"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg
    >
  </button>

  <div
    class="hs-dropdown-menu duration left-[20%]! top-[98%]! mt-2 hidden transform-none! rounded-lg bg-neutral-50 p-2 opacity-0 shadow-md transition-[opacity,margin] before:absolute before:-top-4 before:start-0 before:h-4 before:w-full after:absolute after:-bottom-4 after:start-0 after:h-4 after:w-full hs-dropdown-open:opacity-100 dark:divide-neutral-700 dark:border dark:border-neutral-700 dark:bg-neutral-800 md:left-[90%]! md:top-[80%]!"
    aria-labelledby="hs-dropdown-hover-event"
  >
    {
      Object.entries(languages).map(([lang, label]) => (
        <a
          class="flex items-center gap-x-3.5 rounded-lg px-3 py-2 text-sm text-neutral-800 hover:bg-neutral-100 focus:bg-neutral-100 focus:outline-hidden dark:text-neutral-400 dark:hover:bg-neutral-700 dark:hover:text-neutral-300 dark:focus:bg-neutral-700"
          href={`/${lang === "vn" ? "" : lang}`}
        >
          {label}
        </a>
      ))
    }
  </div>
</div>

<!-- Mobile: accordion (same style as products dropdown) -->
<div class="md:hidden">
  <button
    type="button"
    id="lang-mobile-toggle"
    class="flex items-center gap-x-1 font-medium text-neutral-600 outline-none transition duration-300 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-300"
  >
    <Icon name="earth" />
    <svg
      id="lang-mobile-arrow"
      class="h-4 w-4 shrink-0 transition-transform duration-200"
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="m6 9 6 6 6-6"></path>
    </svg>
  </button>

  <ul id="lang-mobile-list" class="hidden mt-1 flex-col gap-y-0 border-l-2 border-yellow-300/60 pl-3 dark:border-neutral-600">
    {
      Object.entries(languages).map(([lang, label]) => (
        <li>
          <a
            href={`/${lang === "vn" ? "" : lang}`}
            class="block py-2 text-sm text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-300"
          >
            {label}
          </a>
        </li>
      ))
    }
  </ul>
</div>

<script>
  // Type alias for supported languages
  type TLanguage = "en" | "vn";
  // array of supported languages
  const languages: TLanguage[] = ["en", "vn"];

  function handleLangLinkClick(link: HTMLAnchorElement) {
    const lang = link
      .getAttribute("href")
      ?.replace("/", "")
      .replace("/", "") as TLanguage;

    link.addEventListener("click", function (event) {
      event.preventDefault();

      const url = new URL(window.location.href);

      const currentPath = url.pathname
        .split("/")
        .filter((part) => part && !languages.includes(part as TLanguage))
        .join("/");

      let newPath = "";
      if (lang && lang !== "vn") {
        newPath = `/${lang}/${currentPath}`;
      } else {
        newPath = `/${currentPath}`;
      }

      newPath = newPath.replace(/\/+/g, "/");
      if (newPath === "") newPath = "/";

      window.location.href = `${url.origin}${newPath}${url.search}`;
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Desktop dropdown links
    const desktopLinks = document.querySelectorAll(".hs-dropdown-menu[aria-labelledby='hs-dropdown-hover-event'] a");
    desktopLinks.forEach((el) => handleLangLinkClick(el as HTMLAnchorElement));

    // Mobile accordion links
    const mobileLinks = document.querySelectorAll("#lang-mobile-list a");
    mobileLinks.forEach((el) => handleLangLinkClick(el as HTMLAnchorElement));

    // Mobile accordion toggle
    const toggle = document.getElementById("lang-mobile-toggle");
    const list = document.getElementById("lang-mobile-list");
    const arrow = document.getElementById("lang-mobile-arrow");

    if (toggle && list) {
      toggle.addEventListener("click", () => {
        const isOpen = !list.classList.contains("hidden");
        if (isOpen) {
          list.classList.add("hidden");
          list.classList.remove("flex");
          if (arrow) arrow.style.transform = "";
        } else {
          list.classList.remove("hidden");
          list.classList.add("flex");
          if (arrow) arrow.style.transform = "rotate(180deg)";
        }
      });
    }
  });
</script>
