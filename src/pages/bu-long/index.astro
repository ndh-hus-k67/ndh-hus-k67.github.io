---
import MainLayout from "@/layouts/MainLayout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

// Lấy tất cả sản phẩm bu lông
const allProducts: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id, data }) => {
    const categorySlug = typeof data.category === 'string' ? data.category : data.category?.slug;
    return categorySlug === "bu-long";
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

// Nhóm sản phẩm theo productType — lấy trực tiếp từ nội dung `products`
const productsByType = (() => {
  const map = new Map();
  for (const p of allProducts) {
    const pt = p.data.productType;
    const slug = typeof pt === "string" ? pt : pt?.slug;
    if (!slug) continue;
    const name = typeof pt === "string" ? slug : pt?.name ?? slug;
    if (!map.has(slug)) map.set(slug, { slug, name, products: [] });
    map.get(slug).products.push(p);
  }
  return Array.from(map.values())
    .map(t => ({ ...t, products: t.products.slice(0, 3), count: t.products.length }))
    .filter(t => t.count > 0);
})();

const title = "Bu Lông";
const description = "Khám phá bộ sưu tập bu lông chất lượng cao của chúng tôi, bao gồm bu lông inox, bu lông lục giác, bu lông chữ T và nhiều loại khác, phù hợp cho mọi dự án xây dựng và lắp ráp cơ khí.";

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Header -->
    <div class="mb-8 max-w-2xl sm:mb-12">
      <h1
        class="text-balance text-2xl font-bold tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {title}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
    </div>

    <!-- Nội dung: danh sách tất cả sản phẩm + sidebar danh mục -->
    <div class="grid gap-8 lg:grid-cols-4">
      <!-- Main: danh sách sản phẩm -->
      <div class="lg:col-span-3">
        <div class="grid gap-6 grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
          {
            allProducts.map(p => {
              const slug = p.data?.slug || p.id?.split('/').pop()?.replace('.md', '');
              const productTypeSlug = typeof p.data.productType === 'string' ? p.data.productType : p.data.productType?.slug || '';
              const titleText = p.data?.title ?? slug;
              const imgSrc = p.data?.main?.imgCard || p.data?.main?.imgMain || "@/images/product-default.avif";
              const imgAlt = p.data?.main?.imgAlt || titleText;
              return (
                <a href={`/bu-long/${productTypeSlug}/${slug}`} class="group block">
                  <div class="relative aspect-square overflow-hidden rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl">
                    <Image
                      src={imgSrc}
                      alt={imgAlt}
                      class="absolute inset-0 h-full w-full object-cover object-center transition-transform duration-500 group-hover:scale-110"
                      format={"avif"}
                      loading="lazy"
                    />
                  </div>
                  <h3 class="mt-3 text-sm font-semibold text-neutral-800 dark:text-neutral-200">
                    {titleText}
                  </h3>
                </a>
              );
            })
          }
        </div>
      </div>

      <!-- Sidebar: danh sách các danh mục/productType trong bu-long -->
      <aside class="hidden lg:block lg:col-span-1">
        <div class="sticky top-20 rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-700 dark:bg-neutral-800">
          <h4 class="text-sm font-semibold text-neutral-700 dark:text-neutral-200">Danh mục Bu Lông</h4>
          <ul class="mt-3 space-y-2">
            {
              productsByType.map(pt => (
                <li>
                  <a href={`/bu-long/${pt.slug}`} class="flex items-center justify-between text-sm text-neutral-600 hover:text-orange-500 dark:text-neutral-400">
                    <span>{pt.name}</span>
                    <span class="text-neutral-400 dark:text-neutral-500">{pt.count}</span>
                  </a>
                </li>
              ))
            }
          </ul>
        </div>
      </aside>
    </div>

    <!-- Link tìm kiếm nâng cao -->
    <div class="mt-12 text-center">
      <a
        href="/bu-long/search"
        class="inline-flex items-center gap-2 rounded-lg bg-orange-400 px-6 py-3 text-sm font-medium text-white hover:bg-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        Tìm kiếm nâng cao
      </a>
    </div>
  </div>
</MainLayout>
