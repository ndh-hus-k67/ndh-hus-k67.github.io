---
import MainLayout from "@/layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

export async function getStaticPaths() {
  return [
    { params: { category: "bu-long" } },
    { params: { category: "oc-vit" } },
    { params: { category: "san-pham-khac" } },
  ];
}

const { category } = Astro.params;

// Get all products in this category
const allProducts: CollectionEntry<"products">[] = await getCollection(
  "products",
  ({ id, data }) => {
    return id.startsWith("en/") && data.category === category;
  }
);

// Hide specific subcategories in English
const hiddenSubcategoriesByCategory: Record<string, Set<string>> = {
  "bu-long": new Set(["inox", "luc-giac"]),
};

const hiddenSubcategories = hiddenSubcategoriesByCategory[category as string] ?? new Set();

// Get unique subcategories
const subcategories = [
  ...new Set(
    allProducts
      .map((product) => product.data.subcategory)
      .filter((subcategory) => !hiddenSubcategories.has(subcategory))
  ),
];

// Group products by subcategory
const productsBySubcategory = subcategories.map((subcategory) => ({
  subcategory,
  products: allProducts.filter(
    (product) => product.data.subcategory === subcategory
  ),
}));

// Define titles for each category
const categoryTitles: Record<string, string> = {
  "bu-long": "Bolts",
  "oc-vit": "Screws",
  "san-pham-khac": "Other Products",
};

const categoryDescriptions: Record<string, string> = {
  "bu-long":
    "Explore our collection of high-quality bolts, including stainless steel bolts, hex bolts, and many more, suitable for all construction and assembly projects.",
  "oc-vit":
    "Discover our diverse range of screws from self-tapping screws to stainless steel screws, designed to meet all your fastening needs.",
  "san-pham-khac":
    "Explore additional accessories and tools to complete your projects.",
};

const title = categoryTitles[category as string] || category;
const description = categoryDescriptions[category as string] || "";

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Breadcrumb -->
    <nav class="mb-8 flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a
            href="/en/products"
            class="inline-flex items-center text-sm font-medium text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
          >
            Products
          </a>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2 text-neutral-400">/</span>
            <span
              class="text-sm font-medium capitalize text-neutral-500 dark:text-neutral-500"
            >
              {title}
            </span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8 max-w-2xl sm:mb-12">
      <h1
        class="text-balance text-2xl font-bold tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {title}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
    </div>

    <!-- Subcategories list -->
    <div class="space-y-12">
      {
        productsBySubcategory.map(({ subcategory, products }) => (
          <div>
            <div class="mb-6 flex items-center justify-between">
              <h2 class="text-balance text-xl font-bold capitalize text-neutral-800 md:text-2xl dark:text-neutral-200">
                {subcategory.replace(/-/g, " ")}
              </h2>
              <a
                href={`/en/products/${category}/${subcategory}`}
                class="text-sm font-medium text-orange-400 hover:underline dark:text-orange-400"
              >
                View all →
              </a>
            </div>
            <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
              {products.slice(0, 4).map((product) => (
                <a
                  href={`/en/products/${category}/${subcategory}/${product.id.split("/").pop()?.replace(".md", "")}`}
                  data-astro-prefetch
                  class="group relative flex h-48 items-end overflow-hidden rounded-xl shadow-lg outline-hidden ring-zinc-500 focus-visible:ring-3 dark:ring-zinc-200 dark:focus:outline-hidden md:h-80"
                >
                  <img
                    src={product.data.main.imgCard.src}
                    alt={product.data.main.imgAlt}
                    class="absolute inset-0 h-full w-full object-cover object-center transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110"
                  />
                  <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-neutral-800 via-transparent to-transparent opacity-50" />
                  <span class="relative mb-3 ml-4 inline-block text-sm font-bold text-neutral-50 transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110 md:ml-5 md:text-lg">
                    {product.data.title}
                  </span>
                </a>
              ))}
            </div>
          </div>
        ))
      }
    </div>

    <!-- Back link -->
    <div class="mt-12">
      <a
        href="/en/products"
        class="inline-flex items-center text-sm font-medium text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
      >
        ← Back to all products
      </a>
    </div>
  </div>
</MainLayout>
