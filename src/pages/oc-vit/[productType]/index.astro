---
import MainLayout from "@/layouts/MainLayout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

export async function getStaticPaths() {
  const allProducts = await getCollection("products", ({ id, data }) => {
    const categorySlug = typeof data.category === 'string' ? data.category : data.category?.slug;
    return categorySlug === "oc-vit";
  });

  // Lấy danh sách productType duy nhất
  const productTypes = [
    ...new Set(allProducts.map((product) => product.data.productType?.slug).filter(Boolean)),
  ];

  return productTypes.map(productType => ({
    params: { productType }
  }));
}

const { productType } = Astro.params;

// Lấy tất cả sản phẩm thuộc productType này
const products: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id, data }) => {
    const categorySlug = typeof data.category === 'string' ? data.category : data.category?.slug;
    return (
      categorySlug === "oc-vit" &&
      data.productType?.slug === productType
    );
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

const productTypeDescriptions: Record<string, string> = {
  "vit-ban-ton":
    "Vít bắn tôn tự khoan (vít tự khoan) là loại ốc vít dùng để lắp ghép các chi tiết chưa có sẵn lỗ. Khi thi công, phần mũi khoan của vít có thể xuyên thủng bề mặt tiếp xúc và tạo liên kết chắc chắn. Thường dùng để bắn tôn lợp mái, liên kết tôn với xà gồ/khung thép.",
  "vit-tu-khoan":
    "Vít tự khoan inox theo tiêu chuẩn DIN 7504 dùng để liên kết kim loại, gỗ, kết cấu thép. Có mũi khoan giúp xuyên bề mặt mà không cần khoan mồi, thao tác nhanh và hiệu quả.",
};

const productTypeIntros: Record<string, string[]> = {
  "vit-ban-ton": [
    "Sản phẩm thường đi kèm long đen (cao su/nhựa dẻo) giúp tăng độ kín và giảm thấm nước tại điểm bắn.",
    "Kích thước phổ biến: 4.8×19, 4.8×25, 5.5×19, 5.5×25, 6.3×38 mm.",
    "Vật liệu: Inox 201, 304, 316, Thép mạ kẽm.",
  ],
  "vit-tu-khoan": [
    "Vít tự khoan DIN 7504 có mũ lục giác, dễ dàng thao tác bằng máy/súng bắn vít chuyên dụng.",
    "Kích thước phổ biến: 3.5mm–6.3mm đường kính, chiều dài từ 13–38mm.",
    "Vật liệu: Inox 304, 316, Thép mạ kẽm.",
  ],
};

// Lấy thông tin productType từ sản phẩm đầu tiên
const productTypeName = products[0]?.data.productType?.name || productType;

// Lấy danh sách các giá trị filter có sẵn CHỈ TỪ PRODUCT TYPE NÀY
const availableMaterials = new Set<string>();
const availableDiameters = new Set<string>();
const availableSurfaces = new Set<string>();
const availableApplications = new Set<string>();

products.forEach((product) => {
  product.data.filters?.material?.forEach((m: string) => availableMaterials.add(m));
  product.data.filters?.diameter?.forEach((d: string) => availableDiameters.add(d));
  product.data.filters?.surface?.forEach((s: string) => availableSurfaces.add(s));
  product.data.filters?.application?.forEach((a: string) => availableApplications.add(a));
});

// Mapping tên hiển thị
const materialNames: Record<string, string> = {
  "inox-304": "Inox 304",
  "inox-316": "Inox 316",
  "inox-201": "Inox 201",
  "inox-316l": "Inox 316L",
  "thep-carbon": "Thép carbon",
  "thep-ma-kem": "Thép mạ kẽm",
  "thep-ma-niken": "Thép mạ niken",
};

const surfaceNames: Record<string, string> = {
  "ma-kem": "Mạ kẽm",
  "ma-niken": "Mạ niken",
  "ma-dong": "Mạ đồng",
  "xi-den": "Xi đen",
  "ma-dacromet": "Mạ dacromet",
  "khong-xu-ly": "Không xử lý",
};

const applicationNames: Record<string, string> = {
  "tu-dong-hoa-cong-nghiep": "Tự động hóa công nghiệp",
  "che-tao-may": "Chế tạo máy",
  "nhom-dinh-hinh": "Nhôm định hình",
  "xay-dung": "Xây dựng",
  "ket-cau-thep": "Kết cấu thép",
  "co-khi-chung": "Cơ khí chung",
  "han-chap": "Hàn chập",
  "dong-tau": "Đóng tàu",
  "dien-dien-tu": "Điện - điện tử",
  "bao-mat": "Bảo mật",
  "chong-trom": "Chống trộm",
  "thiet-bi-cong-cong": "Thiết bị công cộng",
  "hoa-chat": "Hóa chất",
  "dau-khi": "Dầu khí",
  "bien": "Gần biển",
  "moi-truong-am": "Môi trường ẩm",
};

const title = `${productTypeName}`;
const description =
  productTypeDescriptions[productType as string] ||
  `Khám phá bộ sưu tập ${(productTypeName || productType || '').toLowerCase()} chất lượng cao của chúng tôi.`;

const introParagraphs = productTypeIntros[productType as string] || [];

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Breadcrumb -->
    <nav class="mb-8 flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a
            href="/bu-long"
            class="inline-flex items-center text-sm font-medium text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
          >
            Bu lông
          </a>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2 text-neutral-400">/</span>
            <span
              class="text-sm font-medium text-neutral-500 dark:text-neutral-500"
            >
              {productTypeName}
            </span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8 max-w-3xl">
      <h1
        class="text-balance text-2xl font-bold tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {title}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
      {
        introParagraphs.length > 0 && (
          <div class="mt-4 space-y-2">
            {introParagraphs.map((paragraph) => (
              <p class="text-sm text-neutral-600 dark:text-neutral-400">
                {paragraph}
              </p>
            ))}
          </div>
        )
      }
    </div>

    <!-- Quick Filters -->
    {(availableMaterials.size > 0 || availableDiameters.size > 0 || availableSurfaces.size > 0 || availableApplications.size > 0) && (
    <div class="mb-8 rounded-lg border border-neutral-200 p-6 dark:border-neutral-700">
      <h2 class="mb-4 text-lg font-bold text-neutral-800 dark:text-neutral-200">
        Bộ lọc nhanh
      </h2>

      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        <!-- Material Quick Filters -->
        {availableMaterials.size > 0 && (
        <div>
          <h3 class="mb-2 text-sm font-medium text-neutral-700 dark:text-neutral-300">
            Vật liệu
          </h3>
          <div class="flex flex-wrap gap-2">
            {Array.from(availableMaterials).sort().map((material) => (
              <button
                data-filter-type="material"
                data-filter-value={material}
                class="filter-btn rounded-lg px-3 py-1.5 text-xs bg-neutral-100 text-neutral-700 hover:bg-neutral-200 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700 cursor-pointer transition-colors"
              >
                {materialNames[material] || material}
              </button>
            ))}
          </div>
        </div>
        )}

        <!-- Diameter Quick Filters -->
        {availableDiameters.size > 0 && (
        <div>
          <h3 class="mb-2 text-sm font-medium text-neutral-700 dark:text-neutral-300">
            Kích thước
          </h3>
          <div class="flex flex-wrap gap-2">
            {Array.from(availableDiameters)
              .sort((a, b) => {
                const aNum = parseFloat(a.replace("M", "").replace("x", "."));
                const bNum = parseFloat(b.replace("M", "").replace("x", "."));
                return aNum - bNum;
              })
              .map((diameter) => (
                <button
                  data-filter-type="diameter"
                  data-filter-value={diameter}
                  class="filter-btn rounded-lg px-3 py-1.5 text-xs bg-neutral-100 text-neutral-700 hover:bg-neutral-200 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700 cursor-pointer transition-colors"
                >
                  {diameter}
                </button>
              ))}
          </div>
        </div>
        )}

        <!-- Surface Quick Filters -->
        {availableSurfaces.size > 0 && (
        <div>
          <h3 class="mb-2 text-sm font-medium text-neutral-700 dark:text-neutral-300">
            Bề mặt
          </h3>
          <div class="flex flex-wrap gap-2">
            {Array.from(availableSurfaces).sort().map((surface) => (
              <button
                data-filter-type="surface"
                data-filter-value={surface}
                class="filter-btn rounded-lg px-3 py-1.5 text-xs bg-neutral-100 text-neutral-700 hover:bg-neutral-200 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700 cursor-pointer transition-colors"
              >
                {surfaceNames[surface] || surface}
              </button>
            ))}
          </div>
        </div>
        )}

        <!-- Application Quick Filters -->
        {availableApplications.size > 0 && (
        <div>
          <h3 class="mb-2 text-sm font-medium text-neutral-700 dark:text-neutral-300">
            Ứng dụng
          </h3>
          <div class="flex flex-wrap gap-2">
            {Array.from(availableApplications)
              .sort()
              .map((application) => (
                <button
                  data-filter-type="application"
                  data-filter-value={application}
                  class="filter-btn rounded-lg px-3 py-1.5 text-xs bg-neutral-100 text-neutral-700 hover:bg-neutral-200 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700 cursor-pointer transition-colors"
                >
                  {applicationNames[application] || application}
                </button>
              ))}
          </div>
        </div>
        )}
      </div>

      <div class="mt-4 flex gap-3">
        <button
          id="clearFilters"
          class="rounded-lg border border-neutral-300 px-4 py-2 text-sm font-medium text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-800"
        >
          Xóa bộ lọc
        </button>
        <span id="filterStatus" class="flex items-center text-sm text-neutral-600 dark:text-neutral-400">
          <!-- Filter status will be displayed here -->
        </span>
      </div>
    </div>
    )}

    <!-- Danh sách sản phẩm -->
    <div id="productsGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {
        products.map((product) => {
          const productSlug = product.data.slug || product.id.split('/').pop()?.replace('.md', '');
          return (
          <a
            href={`/oc-vit/${productType}/${productSlug}`}
            data-astro-prefetch
            data-material={JSON.stringify(product.data.filters?.material || [])}
            data-diameter={JSON.stringify(product.data.filters?.diameter || [])}
            data-surface={JSON.stringify(product.data.filters?.surface || [])}
            data-application={JSON.stringify(product.data.filters?.application || [])}
            class="product-card group relative flex h-48 items-end overflow-hidden rounded-xl shadow-lg outline-hidden ring-zinc-500 focus-visible:ring-3 dark:ring-zinc-200 dark:focus:outline-hidden md:h-80"
          >
            <Image
              src={product.data.main.imgCard}
              alt={product.data.main.imgAlt}
              class="absolute inset-0 h-full w-full object-cover object-center transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110"
              format={"avif"}
              loading="lazy"
            />
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-neutral-800 via-transparent to-transparent opacity-50"></div>
            <span class="relative mb-3 ml-4 inline-block text-sm font-bold text-neutral-50 transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110 md:ml-5 md:text-lg">
              {product.data.title}
            </span>
          </a>
        )})
      }
    </div>

    <div id="noResults" class="hidden py-12 text-center">
      <p class="text-lg text-neutral-600 dark:text-neutral-400">
        Không tìm thấy sản phẩm nào phù hợp với bộ lọc của bạn.
      </p>
      <button
        id="showAllProducts"
        class="mt-4 text-orange-400 hover:underline cursor-pointer"
      >
        Xem tất cả sản phẩm →
      </button>
    </div>

    {
      products.length === 0 && (
        <div class="py-12 text-center">
          <p class="text-neutral-600 dark:text-neutral-400">
            Chưa có sản phẩm nào trong danh mục này.
          </p>
        </div>
      )
    }
  </div>
</MainLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const clearButton = document.getElementById("clearFilters");
    const showAllButton = document.getElementById("showAllProducts");
    const productsGrid = document.getElementById("productsGrid");
    const noResults = document.getElementById("noResults");
    const filterStatus = document.getElementById("filterStatus");
    const allCards = document.querySelectorAll(".product-card");

    let activeFilters: Record<string, string[]> = {
      material: [],
      diameter: [],
      surface: [],
      application: []
    };

    function updateFilterDisplay() {
      filterButtons.forEach((btn) => {
        const filterType = btn.getAttribute("data-filter-type") as string;
        const filterValue = btn.getAttribute("data-filter-value") as string;
        
        if (activeFilters[filterType]?.includes(filterValue)) {
          btn.classList.remove("bg-neutral-100", "dark:bg-neutral-800");
          btn.classList.add("bg-orange-400", "text-white", "dark:bg-orange-400");
        } else {
          btn.classList.remove("bg-orange-400", "text-white", "dark:bg-orange-400");
          btn.classList.add("bg-neutral-100", "dark:bg-neutral-800");
        }
      });
    }

    function filterProducts() {
      let visibleCount = 0;
      const hasActiveFilters = Object.values(activeFilters).some(arr => arr.length > 0);

      allCards.forEach((card) => {
        const cardMaterials = JSON.parse(card.getAttribute("data-material") || "[]");
        const cardDiameters = JSON.parse(card.getAttribute("data-diameter") || "[]");
        const cardSurfaces = JSON.parse(card.getAttribute("data-surface") || "[]");
        const cardApplications = JSON.parse(card.getAttribute("data-application") || "[]");

        const matchMaterial = activeFilters.material.length === 0 || 
          activeFilters.material.some(m => cardMaterials.includes(m));
        const matchDiameter = activeFilters.diameter.length === 0 || 
          activeFilters.diameter.some(d => cardDiameters.includes(d));
        const matchSurface = activeFilters.surface.length === 0 || 
          activeFilters.surface.some(s => cardSurfaces.includes(s));
        const matchApplication = activeFilters.application.length === 0 || 
          activeFilters.application.some(a => cardApplications.includes(a));

        const shouldShow = matchMaterial && matchDiameter && matchSurface && matchApplication;

        if (shouldShow) {
          (card as HTMLElement).style.display = "";
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = "none";
        }
      });

      if (visibleCount === 0 && hasActiveFilters) {
        noResults?.classList.remove("hidden");
        productsGrid?.classList.add("hidden");
      } else {
        noResults?.classList.add("hidden");
        productsGrid?.classList.remove("hidden");
      }

      // Update filter status
      if (filterStatus) {
        if (hasActiveFilters) {
          const totalProducts = allCards.length;
          filterStatus.textContent = `Đang lọc: ${visibleCount} / ${totalProducts} sản phẩm`;
        } else {
          filterStatus.textContent = "";
        }
      }
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const filterType = btn.getAttribute("data-filter-type") as string;
        const filterValue = btn.getAttribute("data-filter-value") as string;

        if (!activeFilters[filterType]) {
          activeFilters[filterType] = [];
        }

        const index = activeFilters[filterType].indexOf(filterValue);
        if (index > -1) {
          activeFilters[filterType].splice(index, 1);
        } else {
          activeFilters[filterType].push(filterValue);
        }

        updateFilterDisplay();
        filterProducts();
      });
    });

    clearButton?.addEventListener("click", () => {
      activeFilters = {
        material: [],
        diameter: [],
        surface: [],
        application: []
      };
      updateFilterDisplay();
      filterProducts();
    });

    showAllButton?.addEventListener("click", () => {
      activeFilters = {
        material: [],
        diameter: [],
        surface: [],
        application: []
      };
      updateFilterDisplay();
      filterProducts();
    });
  });
</script>
