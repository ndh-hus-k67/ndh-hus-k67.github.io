---
import MainLayout from "@/layouts/MainLayout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

// Lấy tất cả sản phẩm ốc vít
const allProducts: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id, data }) => {
    const categorySlug = typeof data.category === 'string' ? data.category : data.category?.slug;
    return categorySlug === "oc-vit";
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

// Nhóm sản phẩm theo productType
const productTypes = [
  {
    slug: "vit-ban-ton",
    name: "Vít bắn tôn",
    description: "Vít bắn tôn tự khoan, lắp mái tôn với xà gồ, không cần khoan mồi"
  },
  {
    slug: "vit-tu-khoan",
    name: "Vít tự khoan",
    description: "Vít tự khoan inox DIN 7504, dùng cho gỗ, sắt, kết cấu thép"
  },
  {
    slug: "chuyen-dung",
    name: "Chuyên dụng",
    description: "Bu lông chuyên dụng cho hóa chất, neo móng, tai hồng, nổ"
  }
];

const productsByType = productTypes.map(type => {
  const typeProducts = allProducts.filter(p => p.data.productType?.slug === type.slug);
  return {
    ...type,
    products: typeProducts.slice(0, 3),
    count: typeProducts.length
  };
}).filter(type => type.count > 0);

const title = "Ốc Vít";
const description = "Khám phá bộ sưu tập ốc vít chất lượng cao của chúng tôi, bao gồm vít bắn tôn, vít tự khoan inox, phù hợp cho mọi dự án xây dựng và lắp ráp kết cấu.";

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Header -->
    <div class="mb-8 max-w-2xl sm:mb-12">
      <h1
        class="text-balance text-2xl font-bold tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {title}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
    </div>

    <!-- Danh sách productTypes dạng bảng -->
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {
        productsByType.map(({ slug, name, description, count }) => (
          <a
            href={`/oc-vit/${slug}`}
            class="group relative flex flex-col overflow-hidden rounded-xl border border-neutral-200 bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-lg hover:border-orange-300 dark:border-neutral-700 dark:bg-neutral-800 dark:hover:border-orange-500"
          >
            <div class="flex-1">
              <h2 class="text-lg font-bold text-neutral-800 group-hover:text-orange-500 dark:text-neutral-200 dark:group-hover:text-orange-400 transition-colors">
                {name}
              </h2>
              <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2">
                {description}
              </p>
            </div>
            <div class="mt-4 flex items-center justify-between pt-4 border-t border-neutral-100 dark:border-neutral-700">
              <span class="text-sm font-medium text-neutral-500 dark:text-neutral-400">
                {count} sản phẩm
              </span>
              <span class="text-orange-500 dark:text-orange-400 group-hover:translate-x-1 transition-transform">
                →
              </span>
            </div>
          </a>
        ))
      }
    </div>

    <!-- Link tìm kiếm nâng cao -->
    <div class="mt-12 text-center">
      <a
        href="/oc-vit/search"
        class="inline-flex items-center gap-2 rounded-lg bg-orange-400 px-6 py-3 text-sm font-medium text-white hover:bg-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        Tìm kiếm nâng cao
      </a>
    </div>
  </div>
</MainLayout>
