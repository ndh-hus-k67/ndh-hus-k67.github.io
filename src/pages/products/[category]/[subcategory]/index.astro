---
import MainLayout from "@/layouts/MainLayout.astro";
import CardSmall from "@components/ui/cards/CardSmall.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

export async function getStaticPaths() {
  const allProducts = await getCollection("products", ({ id }) =>
    id.startsWith("vn/")
  );

  // Tạo tất cả các paths có thể có
  const paths = allProducts.map((product) => {
    const category = product.data.category;
    const subcategory = product.data.subcategory;
    return {
      params: { category, subcategory },
    };
  });

  // Loại bỏ duplicate paths
  const uniquePaths = paths.filter(
    (path, index, self) =>
      index ===
      self.findIndex(
        (p) =>
          p.params.category === path.params.category &&
          p.params.subcategory === path.params.subcategory
      )
  );

  return uniquePaths;
}

const { category, subcategory } = Astro.params;

// Lấy tất cả sản phẩm thuộc subcategory này
const products: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id, data }) => {
    return (
      id.startsWith("vn/") &&
      data.category === category &&
      data.subcategory === subcategory
    );
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

// Định nghĩa tiêu đề
const categoryTitles: Record<string, string> = {
  "bu-long": "Bu Lông",
  "oc-vit": "Ốc Vít",
  "san-pham-khac": "Sản Phẩm Khác",
};

const categoryTitle = categoryTitles[category as string] || category;
const subcategoryTitle = (subcategory as string).replace(/-/g, " ");

const title = `${subcategoryTitle} - ${categoryTitle}`;
const description = `Khám phá bộ sưu tập ${subcategoryTitle.toLowerCase()} chất lượng cao của chúng tôi.`;

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Breadcrumb -->
    <nav class="mb-8 flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a
            href="/products"
            class="inline-flex items-center text-sm font-medium text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
          >
            Sản phẩm
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <span class="mx-2 text-neutral-400">/</span>
            <a
              href={`/products/${category}`}
              class="text-sm font-medium capitalize text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
            >
              {categoryTitle}
            </a>
          </div>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <span class="mx-2 text-neutral-400">/</span>
            <span
              class="text-sm font-medium capitalize text-neutral-500 dark:text-neutral-500"
            >
              {subcategoryTitle}
            </span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8 max-w-2xl sm:mb-12">
      <h1
        class="text-balance text-2xl font-bold capitalize tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {subcategoryTitle}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
    </div>

    <!-- Products Grid -->
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {
        products.map((product) => (
          <a
            href={`/products/${category}/${subcategory}/${product.id.split("/").pop()?.replace(".md", "")}`}
            data-astro-prefetch
            class="group relative flex h-48 items-end overflow-hidden rounded-xl shadow-lg outline-hidden ring-zinc-500 focus-visible:ring-3 dark:ring-zinc-200 dark:focus:outline-hidden md:h-80"
          >
            <img
              src={product.data.main.imgCard.src}
              alt={product.data.main.imgAlt}
              class="absolute inset-0 h-full w-full object-cover object-center transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110"
            />
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-neutral-800 via-transparent to-transparent opacity-50" />
            <span class="relative mb-3 ml-4 inline-block text-sm font-bold text-neutral-50 transition duration-[600ms] ease-[cubic-bezier(0.45,0,0.55,1)] group-hover:scale-110 md:ml-5 md:text-lg">
              {product.data.title}
            </span>
          </a>
        ))
      }
    </div>

    {
      products.length === 0 && (
        <div class="py-12 text-center">
          <p class="text-neutral-600 dark:text-neutral-400">
            Chưa có sản phẩm nào trong danh mục này.
          </p>
        </div>
      )
    }

    <!-- Back link -->
    <div class="mt-12">
      <a
        href={`/products/${category}`}
        class="inline-flex items-center text-sm font-medium text-neutral-600 hover:text-orange-400 dark:text-neutral-400 dark:hover:text-orange-400"
      >
        ← Quay lại {categoryTitle}
      </a>
    </div>
  </div>
</MainLayout>
