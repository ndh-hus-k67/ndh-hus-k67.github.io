---
// Importing necessary components
import MainLayout from "@/layouts/MainLayout.astro";
import PrimaryCTA from "@components/ui/buttons/PrimaryCTA.astro";
import CardSmall from "@components/ui/cards/CardSmall.astro";
import CardWide from "@components/ui/cards/CardWide.astro";
import FeaturesStatsAlt from "@components/sections/features/FeaturesStatsAlt.astro";
import TestimonialsSectionAlt from "@components/sections/testimonials/TestimonialsSectionAlt.astro";

import { getSubcategoryTitleVN } from "@/utils/productTitles";
import { SITE } from "@data/constants";

// Importing necessary functions from Astro
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

// Fetching all the product related content and sorting it by main.id
const allProducts: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id }) => {
    return id.startsWith("vn/");
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

// Nhóm sản phẩm theo category
const categories = [
  {
    slug: "bu-long",
    name: "Bu Lông",
    description: "Khám phá bộ sưu tập bu lông chất lượng cao của chúng tôi, bao gồm bu lông inox, bu lông lục giác và nhiều loại khác.",
    icon: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
  },
  {
    slug: "oc-vit",
    name: "Ốc Vít",
    description: "Tìm hiểu các loại ốc vít đa dạng từ ốc vít bắn tôn đến ốc vít inox, được thiết kế để đáp ứng mọi nhu cầu cố định.",
    icon: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
  },
  {
    slug: "san-pham-khac",
    name: "Sản Phẩm Khác",
    description: "Khám phá các sản phẩm phụ kiện và công cụ bổ sung khác để hoàn thiện dự án của bạn.",
    icon: "M20 7h-7M20 12h-7M20 17h-7M3 7h4M3 12h4M3 17h4"
  }
];

const productsByCategory = categories.map(category => {
  const categoryProducts = allProducts.filter(p => p.data.category === category.slug);

  const previewCount = 3;

  // Lấy danh sách subcategories với số lượng sản phẩm
  const subcategoriesMap = new Map<string, { name: string; count: number; products: CollectionEntry<"products">[] }>();

  categoryProducts.forEach(product => {
    const subcat = product.data.subcategory;
    if (!subcategoriesMap.has(subcat)) {
      subcategoriesMap.set(subcat, {
        name: getSubcategoryTitleVN(subcat),
        count: 0,
        products: []
      });
    }
    const subcatData = subcategoriesMap.get(subcat)!;
    subcatData.count++;
    if (subcatData.products.length < previewCount) {
      subcatData.products.push(product);
    }
  });

  const subcategories = Array.from(subcategoriesMap.entries()).map(([slug, data]) => ({
    slug,
    name: data.name,
    count: data.count,
    products: data.products
  }));

  return {
    ...category,
    products: categoryProducts.slice(0, previewCount),
    count: categoryProducts.length,
    subcategories
  };
});

// Define variables for page content
const title: string = "Sản phẩm";
const subTitle: string =
  "Khám phá độ bền và độ chính xác của các công cụ ScrewFast, được thiết kế dành cho cả chuyên gia lẫn người đam mê. Mỗi sản phẩm của chúng tôi đều được chế tạo tỉ mỉ và hướng tới độ bền lâu dài, đảm bảo bạn luôn có đúng công cụ cho mọi công việc.";

// Testimonial data that will be rendered in the component
const testimonials = [
  {
    content:
      "Kể từ khi chúng tôi sử dụng các công cụ phần cứng của ScrewFast, hiệu suất làm việc tại các công trường đã tăng vọt. Độ bền của bu lông lục giác và độ chính xác của vít máy thực sự không có đối thủ. Thật tuyệt khi làm việc với một công ty thực sự hiểu rõ những yêu cầu khắt khe hằng ngày của ngành xây dựng.",
    author: "Jason Clark",
    role: "Giám sát công trường | TopBuild",
    avatarSrc:
      "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=1374&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=facearea&facepad=2&w=320&h=320&q=80",
    avatarAlt: "Mô tả hình ảnh",
  },

  {
    content:
      "Là một nhà thiết kế nội thất, tôi luôn tìm kiếm các vật liệu và công cụ chất lượng cao để hiện thực hóa ý tưởng của mình. Bộ vít tổng hợp của ScrewFast đã thay đổi hoàn toàn các dự án của tôi, mang lại sự kết hợp hoàn hảo giữa chất lượng và sự đa dạng. Dịch vụ hỗ trợ khách hàng tuyệt vời chính là điểm cộng lớn nhất!",
    author: "Maria Gonzalez",
    role: "Nhà thiết kế nội thất | Creative Spaces",
    avatarSrc:
      "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1376&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D8&auto=format&fit=facearea&facepad=2&w=320&h=320&q=80",
    avatarAlt: "Mô tả hình ảnh",
  },

  {
    content:
      "Tôi là thợ mộc chuyên nghiệp với hơn 15 năm kinh nghiệm, và có thể khẳng định rằng bu lông và đai ốc taro của ScrewFast thuộc hàng tốt nhất tôi từng sử dụng. Chúng bám chắc vượt trội, mang lại cho tôi sự tin tưởng tuyệt đối trong từng mối ghép. Hơn nữa, dịch vụ của họ thật sự xuất sắc – họ thực sự quan tâm đến thành công của dự án của tôi.",
    author: "Richard Kim",
    role: "Thợ mộc bậc thầy | WoodWright",
    avatarSrc:
      "https://images.unsplash.com/photo-1474176857210-7287d38d27c6?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D8&auto=format&fit=facearea&facepad=2&w=320&h=320&q=80",
    avatarAlt: "Mô tả hình ảnh",
  },
];

const pageTitle = `${title} | ${SITE.title}`;
const metaDescription =
  "Khám phá độ bền và độ chính xác của các công cụ ScrewFast, được thiết kế dành cho cả chuyên gia lẫn người đam mê.";
const ogTitle = "Dụng cụ phần cứng | ScrewFast";
---

<MainLayout
  title={pageTitle}
  customDescription={metaDescription}
  customOgTitle={ogTitle}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": "https://screwfast.uk/products",
    url: "https://screwfast.uk/products",
    name: "Dụng cụ phần cứng | ScrewFast",
    description:
      "Khám phá độ bền và độ chính xác của các công cụ ScrewFast, được thiết kế dành cho cả chuyên gia lẫn người đam mê.",
    isPartOf: {
      "@type": "WebSite",
      url: "https://screwfast.uk",
      name: "ScrewFast",
      description:
        "ScrewFast cung cấp các công cụ phần cứng cao cấp và dịch vụ xây dựng chuyên nghiệp để đáp ứng mọi nhu cầu dự án của bạn.",
    },
    inLanguage: "vn",
  }}
>
  <!-- Header Section -->
  <div class="mx-auto max-w-[85rem] px-4 py-12 sm:px-6 sm:py-16 lg:px-8 2xl:max-w-full">
    <div class="mb-12 text-center">
      <h1 class="text-balance text-4xl font-bold tracking-tight text-neutral-800 md:text-5xl dark:text-neutral-200">
        {title}
      </h1>
      {subTitle && (
        <p class="mx-auto mt-4 max-w-3xl text-pretty text-lg text-neutral-600 dark:text-neutral-400">
          {subTitle}
        </p>
      )}
      <div class="mt-8">
        <PrimaryCTA
          title="Câu chuyện khách hàng"
          url="#customer"
          noArrow={true}
        />
      </div>
    </div>
  </div>

  <!-- Main Content: Sidebar + Products Grid -->
  <div class="mx-auto max-w-[85rem] px-4 pb-10 sm:px-6 lg:px-8 lg:pb-14 2xl:max-w-full">
    <div class="flex flex-col gap-8 lg:flex-row lg:gap-12">
      <!-- Sidebar - Categories Navigation -->
      <aside class="lg:w-72 lg:shrink-0">
        <div class="sticky top-24 space-y-5">
          <div class="rounded-xl bg-neutral-50 p-5 dark:bg-neutral-800/50">
            <h2 class="mb-5 text-base font-bold uppercase tracking-wide text-neutral-700 dark:text-neutral-300">
              Danh mục sản phẩm
            </h2>
            <nav class="space-y-2">
              {productsByCategory.map((category) => (
                <div class="space-y-1">
                  <a
                    href={`#category-${category.slug}`}
                    data-category={category.slug}
                    class="category-link group flex items-center gap-3 rounded-lg px-3 py-2.5 transition-colors"
                  >
                    <svg
                      class="h-5 w-5 text-orange-500"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" d={category.icon} />
                    </svg>
                    <div class="min-w-0 flex-1">
                      <h3 class="font-semibold text-neutral-800 dark:text-neutral-200">
                        {category.name}
                      </h3>
                    </div>
                  </a>

                  {/* Subcategories */}
                  {category.subcategories && category.subcategories.length > 0 && (
                    <div class="ml-8 space-y-0.5 pl-4">
                      {category.subcategories.map((subcat) => (
                        <a
                          href={`#subcat-${category.slug}-${subcat.slug}`}
                          data-subcategory={subcat.slug}
                          class="subcategory-link block rounded-md px-3 py-1.5 text-sm text-neutral-600 transition-colors dark:text-neutral-400"
                        >
                          {subcat.name}
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </nav>
          </div>

          <!-- Quick Info Card -->
          <div class="rounded-xl bg-orange-50 p-5 dark:bg-orange-950/50">
            <h3 class="mb-2 text-base font-bold text-neutral-800 dark:text-neutral-200">
              Cần tư vấn?
            </h3>
            <p class="mb-4 text-sm leading-relaxed text-neutral-600 dark:text-neutral-300">
              Đội ngũ chuyên gia của chúng tôi sẵn sàng hỗ trợ bạn chọn sản phẩm phù hợp.
            </p>
            <a
              href="/contact"
              class="inline-flex items-center text-sm font-semibold text-orange-600 dark:text-orange-400"
            >
              Liên hệ ngay →
            </a>
          </div>
        </div>
      </aside>

      <!-- Products Grid -->
      <main class="min-w-0 flex-1">
        <div class="space-y-20">
          {productsByCategory.map((category) => (
            <section id={`category-${category.slug}`} class="scroll-mt-24">
              <div class="mb-8">
                <div class="flex items-end justify-between">
                  <h2 class="text-balance text-3xl font-bold text-neutral-800 md:text-4xl dark:text-neutral-200">
                    {category.name}
                  </h2>
                  <a
                    href={`/products/${category.slug}`}
                    class="shrink-0 text-sm font-medium text-orange-500 dark:text-orange-400"
                  >
                    Khám phá thêm →
                  </a>
                </div>
                <p class="mt-3 max-w-3xl text-base text-neutral-600 dark:text-neutral-400">
                  {category.description}
                </p>
              </div>

              {/* Subcategories sections */}
              {category.subcategories && category.subcategories.length > 0 ? (
                <div class="space-y-14">
                  {category.subcategories.map((subcat) => (
                    <div id={`subcat-${category.slug}-${subcat.slug}`} class="scroll-mt-24">
                      <div class="mb-5 flex items-baseline justify-between">
                        <h3 class="text-xl font-bold text-neutral-800 dark:text-neutral-200">
                          {subcat.name}
                        </h3>
                        <a
                          href={`/products/${category.slug}/${subcat.slug}`}
                          class="text-sm font-medium text-orange-500 dark:text-orange-400"
                        >
                          Xem thêm loại khác →
                        </a>
                      </div>

                      <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                        {subcat.products.map((product) => (
                          <a
                            href={`/products/${product.data.category}/${product.data.subcategory}/${product.id.split("/").pop()?.replace(".md", "")}`}
                            data-astro-prefetch
                            class="group relative flex h-72 items-end overflow-hidden rounded-lg"
                          >
                            <img
                              src={
                                typeof product.data.main.imgCard === "string"
                                  ? product.data.main.imgCard
                                  : product.data.main.imgCard.src
                              }
                              alt={product.data.main.imgAlt}
                              class="absolute inset-0 h-full w-full object-cover object-center transition duration-500 group-hover:scale-105"
                            />
                            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-neutral-900/80 via-neutral-900/30 to-transparent" />
                            <div class="relative w-full p-5">
                              <span class="inline-block text-lg font-bold text-white">
                                {product.data.title}
                              </span>
                            </div>
                          </a>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                  {category.products.map((product) => (
                    <a
                      href={`/products/${product.data.category}/${product.data.subcategory}/${product.id.split("/").pop()?.replace(".md", "")}`}
                      data-astro-prefetch
                      class="group relative flex h-72 items-end overflow-hidden rounded-lg"
                    >
                      <img
                        src={
                          typeof product.data.main.imgCard === "string"
                            ? product.data.main.imgCard
                            : product.data.main.imgCard.src
                        }
                        alt={product.data.main.imgAlt}
                        class="absolute inset-0 h-full w-full object-cover object-center transition duration-500 group-hover:scale-105"
                      />
                      <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-neutral-900/80 via-neutral-900/30 to-transparent" />
                      <div class="relative w-full p-5">
                        <span class="inline-block text-lg font-bold text-white">
                          {product.data.title}
                        </span>
                      </div>
                    </a>
                  ))}
                </div>
              )}
            </section>
          ))}
        </div>
      </main>
    </div>
  </div>

  <script>
    // Smooth scroll behavior for category links
    document.addEventListener('DOMContentLoaded', () => {
      const categoryLinks = document.querySelectorAll('.category-link');

      categoryLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href');
          if (!targetId) return;
          const targetElement = document.querySelector(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });

      // Highlight active category on scroll
      const observerOptions = {
        root: null,
        rootMargin: '-100px 0px -66%',
        threshold: 0
      };

      // Handle subcategory links
      const subcategoryLinks = document.querySelectorAll('.subcategory-link');
      subcategoryLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href');
          if (!targetId) return;
          const targetElement = document.querySelector(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute('id');

            // Highlight category or subcategory
            if (id?.startsWith('category-')) {
              categoryLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === `#${id}`) {
                  link.classList.add('bg-white', 'dark:bg-neutral-700');
                } else {
                  link.classList.remove('bg-white', 'dark:bg-neutral-700');
                }
              });
            } else if (id?.startsWith('subcat-')) {
              subcategoryLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === `#${id}`) {
                  link.classList.add('bg-white', 'dark:bg-neutral-700', 'font-semibold');
                } else {
                  link.classList.remove('bg-white', 'dark:bg-neutral-700', 'font-semibold');
                }
              });
            }
          }
        });
      }, observerOptions);

      document.querySelectorAll('section[id^="category-"], div[id^="subcat-"]').forEach(section => {
        observer.observe(section);
      });
    });
  </script>

  <FeaturesStatsAlt
    title="Vì sao nên chọn ScrewFast?"
    subTitle="Biến ý tưởng của bạn thành kết quả thực tế với các công cụ ScrewFast. Dù bạn bắt đầu từ một bản phác thảo đơn giản hay triển khai một dự án xây dựng hoàn chỉnh, công cụ của chúng tôi luôn đồng hành để bạn xây dựng với sự tự tin."
    benefits={[
      "Công cụ bền bỉ và đáng tin cậy cho hiệu suất lâu dài.",
      "Giải pháp sáng tạo phù hợp với nhu cầu xây dựng hiện đại.",
      "Hỗ trợ khách hàng tận tâm cho sự thành công của dự án.",
    ]}
  />

  <div id="customer" class="scroll-mt-24">
  <TestimonialsSectionAlt
    title="Khách hàng nói gì về chúng tôi"
    testimonials={testimonials}
  />
</div>
</MainLayout>
