---
import MainLayout from "@/layouts/MainLayout.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

// Lấy tất cả sản phẩm tán tự giữ
const allProducts: CollectionEntry<"products">[] = (
  await getCollection("products", ({ id, data }) => {
    const categorySlug = typeof data.category === 'string' ? data.category : data.category?.slug;
    return categorySlug === "tan-tu-giu";
  })
).sort(
  (a: CollectionEntry<"products">, b: CollectionEntry<"products">) =>
    a.data.main.id - b.data.main.id
);

// Nhóm sản phẩm theo productType — lấy trực tiếp từ nội dung `products`
const productsByType = (() => {
  const map = new Map();
  for (const p of allProducts) {
    const pt = p.data.productType;
    const slug = typeof pt === "string" ? pt : pt?.slug;
    if (!slug) continue;
    const name = typeof pt === "string" ? slug : pt?.name ?? slug;
    if (!map.has(slug)) map.set(slug, { slug, name, products: [] });
    map.get(slug).products.push(p);
  }
  return Array.from(map.values())
    .map(t => ({ ...t, products: t.products.slice(0, 3), count: t.products.length }))
    .filter(t => t.count > 0);
})();

const title = "Tán tự giữ";
const description = "Khám phá bộ sưu tập tán tự giữ chất lượng cao của chúng tôi — đa dạng loại, vật liệu và kích thước, phù hợp cho công nghiệp và xây dựng.";

const pageTitle = `${title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={description}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
  }}
>
  <div
    class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
  >
    <!-- Header -->
    <div class="mb-8 max-w-2xl sm:mb-12">
      <h1
        class="text-balance text-2xl font-bold tracking-tight text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200"
      >
        {title}
      </h1>
      <p class="mt-4 text-pretty text-neutral-600 dark:text-neutral-400">
        {description}
      </p>
    </div>

    <!-- Nội dung: danh sách tất cả sản phẩm + sidebar danh mục -->
    <div class="grid gap-8 lg:grid-cols-4">
      <!-- Main: danh sách sản phẩm -->
      <div class="lg:col-span-3">
        <div class="grid gap-6 grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
          {
            allProducts.map(p => {
              const slug = p.data?.slug || p.id?.split('/').pop()?.replace('.md', '');
              const productTypeSlug = typeof p.data.productType === 'string' ? p.data.productType : p.data.productType?.slug || '';
              const alias = productTypeSlug.replace(/^tan-tu-giu-/, '');
              const dataTypes = `${productTypeSlug} ${alias}`.trim();
              const titleText = p.data?.title ?? slug;
              const imgSrc = p.data?.main?.imgCard || p.data?.main?.imgMain || "@/images/product-default.avif";
              const imgAlt = p.data?.main?.imgAlt || titleText;
              return (
                <a href={`/tan-tu-giu/${productTypeSlug}/${slug}`} data-product-type={dataTypes} class="group block product-item">
                  <div class="relative aspect-square overflow-hidden rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl">
                    <Image
                      src={imgSrc}
                      alt={imgAlt}
                      class="absolute inset-0 h-full w-full object-cover object-center transition-transform duration-500 group-hover:scale-110"
                      format={"avif"}
                      loading="lazy"
                    />
                  </div>
                  <h3 class="mt-3 text-sm font-semibold text-neutral-800 dark:text-neutral-200">
                    {titleText}
                  </h3>
                </a>
              );
            })
          }
        </div>
      </div>

      <!-- Sidebar: danh sách các danh mục/productType trong tán tự giữ -->
     <aside class="hidden lg:block lg:col-span-1">
  <div class="sticky top-20 rounded-xl border border-neutral-200 bg-white dark:border-neutral-700 dark:bg-neutral-900">
    
    <!-- Header -->
    <div class="flex items-center gap-2 border-b border-neutral-200 px-4 py-3 dark:border-neutral-700">
      <svg class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M20 13V7a2 2 0 00-2-2h-4M4 11V7a2 2 0 012-2h4M4 17v-2m16 2v-2M9 21h6" />
      </svg>
      <h4 class="text-sm font-semibold text-neutral-800 dark:text-neutral-200">
        Danh mục Tán tự giữ
      </h4>
    </div>

    <!-- Danh sách -->
    <ul class="p-3 space-y-1">

      <!-- All -->
      <li>
        <button
          data-filter-type="all"
          class="filter-type-btn group flex w-full items-center justify-between rounded-lg border border-transparent px-3 py-2 text-sm text-neutral-700 hover:border-orange-200 hover:bg-orange-50 hover:text-orange-600 dark:text-neutral-300 dark:hover:bg-neutral-800"
        >
          <span class="truncate">Tất cả sản phẩm</span>
          <span class="rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400">
            {allProducts.length}
          </span>
        </button>
      </li>

      {productsByType.map(pt => (
        <li>
          <button
            data-filter-type={pt.slug}
            class="filter-type-btn group flex w-full items-center justify-between rounded-lg border border-transparent px-3 py-2 text-sm text-neutral-700 hover:border-orange-200 hover:bg-orange-50 hover:text-orange-600 dark:text-neutral-300 dark:hover:bg-neutral-800"
          >
            <span class="truncate">{pt.name}</span>
            <span class="rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400">
              {pt.count}
            </span>
          </button>
        </li>
      ))}

    </ul>
  </div>
</aside>

    </div>

   
  </div>
 
<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    const filterButtons = document.querySelectorAll('.filter-type-btn');
    const productItems = document.querySelectorAll('.product-item');

    function setActive(button) {
      filterButtons.forEach((b) => {
        b.classList.remove('font-semibold', 'text-orange-500');
      });
      button.classList.add('font-semibold', 'text-orange-500');
    }

    function applyFilter(type) {
      if (type === 'all') {
        productItems.forEach((p) => {
          p.style.display = '';
        });
        return;
      }

      productItems.forEach((p) => {
        const ptAttr = p.getAttribute('data-product-type') || '';
        const types = ptAttr.split(/\s+/).filter(Boolean);
        p.style.display = types.includes(type) ? '' : 'none';
      });
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const t = btn.getAttribute('data-filter-type');
        if (!t) return;
        setActive(btn);
        applyFilter(t);
      });
    });

    const first = document.querySelector('[data-filter-type="all"]');
    if (first) first.click();
  });
  </script>
</MainLayout>
